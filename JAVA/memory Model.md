# Java 内存管理

> [!TIP]
> 堆内存、方法区、栈内存三者的关系：堆内存存放对象实例和数组，方法区存放类信息、常量、静态变量、即时编译器编译后的代码等数据，栈内存存放局部变量、方法调用、返回地址等信息。

- [Java 内存管理](#java-内存管理)
  - [内存模型](#内存模型)
  - [栈「Stack」](#栈stack)
  - [堆「Heap」](#堆heap)
  - [方法区](#方法区)
  - [本地方法区](#本地方法区)
  - [寄存器](#寄存器)
  - [总结](#总结)

## 内存模型

Java 内存模型（Memory Model）是 Java 平台内存管理的基础，它定义了程序中变量的访问规则，以及在多线程环境下对变量的访问的同步规则。

Java 内存模型规定了变量在内存中的存储布局，以及变量的访问规则。Java 内存模型定义了程序中变量的访问规则，包括变量的创建、分配、读写、释放等。Java 内存模型规定了变量的访问规则，包括变量的创建、分配、读写、释放等。

1. 变量的创建：在 Java 程序中，变量的创建是指在内存中为变量分配内存空间。

2. 变量的分配：Java 内存模型规定，变量的分配是指将变量存储在堆内存或方法区中。

3. 变量的读写：Java 内存模型规定，变量的读写是指对变量进行读写操作。

4. 变量的释放：Java 内存模型规定，变量的释放是指将不再使用的变量从内存中清除。

Java 内存模型规定，变量的创建、分配、读写、释放等操作必须满足一定的顺序，这就保证了 Java 程序的正确性。

## 栈「Stack」

> [!NOTE]
> 栈内存是线程私有的，生命周期与线程相同，存放局部变量、方法调用、返回地址等信息。
>
> 栈是方法执行时的内存空间，每个线程都有自己的栈，栈内存是线程私有的，生命周期与线程相同，栈去使用其他方法时也会开辟新的栈帧。当一个方法执行完毕，栈帧就会出栈，释放栈内存。栈自身运行结束后，也会自动释放。
>
> 栈是一种先进后出的数据结构，当一个方法调用另一个方法时，新的方法的栈帧将被压入栈顶，当该方法返回时，栈顶的栈帧将被弹出。

栈是一种先进后出的数据结构：**队列**「Queue」

栈内存的分配和回收都是自动的，无需程序员手动操作。

栈内存的分配：当线程执行一个方法时，JVM 会在栈内存中为该线程分配一个栈帧，用于存储局部变量、方法调用、返回地址等信息。

栈内存的回收：当线程执行结束时，JVM 会自动回收该线程的栈帧，释放栈内存。

## 堆「Heap」

> [!NOTE]
> 堆内存是 Java 虚拟机所管理的内存中最大的一块，栈内存存放局部变量、方法调用、返回地址等信息，堆内存存放对象实例和数组。
>
> 堆是存储对象实例和数组的区域，堆内存是共享的，所有线程<sup>`栈`</sup>都可以访问。
>
> 堆拥有自己的地址值，不同对象的地址值都不相同，每个堆都是不同的实例/数组。
>
> 堆内存的大小可以通过 -Xmx 和 -Xms 选项来设置。堆通常是 `new` 方法触发的

堆内存（Heap Memory）是 Java 虚拟机所管理的内存中最大的一块，用于存放对象实例和数组。堆内存是 JVM 所管理的内存中最大的一块，也是垃圾收集器管理的主要区域。堆内存的分配和回收都是自动的，无需程序员手动操作。

堆内存的分配：当程序创建对象或数组时，JVM 会在堆内存中为对象或数组分配内存空间。

堆内存的回收：当程序不再使用某个对象或数组时，JVM 会自动回收该对象或数组占用的内存空间。

## 方法区

> [!NOTE]
> 方法区是 JVM 所管理的内存中第二大块，用于存放类信息、常量、静态变量、即时编译器编译后的代码等数据。

方法区（Method Area）是 JVM 所管理的内存中第二大块，用于存放类信息、常量、静态变量、即时编译器编译后的代码等数据。

方法区是 JVM 所管理的内存中第二大块，也是垃圾收集器管理的第二个区域。方法区的主要作用是存储类信息、常量、静态变量、即时编译器编译后的代码等数据。

方法区的分配：当程序加载类时，JVM 会在方法区中为类信息、常量、静态变量、即时编译器编译后的代码等数据分配内存空间。

方法是 java 存储可以执行 class 文件的内存区域，栈、堆、方法区都是 JVM 运行时数据区

方法区的回收：当程序不再使用某个类时，JVM 会自动回收该类占用的内存空间。

## 本地方法区

> [!NOTE]
> 本地方法区是 JVM 所管理的内存中第三大块，用于存放 native 方法栈。

本地方法区（Native Method Area）是 JVM 所管理的内存中第三大块，用于存放 native 方法栈。

native：指的是非 Java 语言编写的程序，如 C、C++、汇编语言等。

他们均是用来调用系统底层的方法接口，因此需要使用 native 方法区来存储 native 方法的栈。

## 寄存器

> [!NOTE]
> 寄存器是 CPU 内部的小容量存储器，用于临时存放数据。

寄存器（Register）是 CPU 内部的小容量存储器，用于临时存放数据。

器的特点是速度快，但是容量有限，所以寄存器只能存放少量数据。

寄存器的作用：

1. 快速访问：寄存器可以快速访问，所以可以用于存放临时数据。

2. 减少内存访问：寄存器可以减少内存访问，所以可以提高程序的运行效率。

3. 降低功耗：寄存器的电压很低，所以可以降低 CPU 的功耗。

## 总结

Java 内存模型定义了程序中变量的访问规则，包括变量的创建、分配、读写、释放等。Java 内存模型规定了变量的创建、分配、读写、释放等操作必须满足一定的顺序，这就保证了 Java 程序的正确性。

栈内存是线程私有的，生命周期与线程相同，存放局部变量、方法调用、返回地址等信息。栈是一种先进后出的数据结构，当一个方法调用另一个方法时，新的方法的栈帧将被压入栈顶，当该方法返回时，栈顶的栈帧将被弹出。

堆内存是 Java 虚拟机所管理的内存中最大的一块，用于存放对象实例和数组。堆内存是共享的，所有线程都可以访问。堆拥有自己的地址值，不同对象的地址值都不相同，每个堆都是不同的实例/数组。

方法区是 JVM 所管理的内存中第二大块，用于存放类信息、常量、静态变量、即时编译器编译后的代码等数据。方法区的主要作用是存储类信息、常量、静态变量、即时编译器编译后的代码等数据。

本地方法区是 JVM 所管理的内存中第三大块，用于存放 native 方法栈。

寄存器是 CPU 内部的小容量存储器，用于临时存放数据。
